<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MBTI Chatbot</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
      max-width: 820px;
      margin: 24px auto;
      padding: 0 14px;
      background: #fafafa;
    }
    h1 { margin-bottom: 8px; }
    #chat {
      border: 1px solid #ddd;
      border-radius: 14px;
      padding: 14px;
      height: 60vh;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: #fff;
    }
    .msg {
      padding: 10px 14px;
      border-radius: 14px;
      white-space: pre-wrap;
      line-height: 1.5;
      max-width: 85%;
    }
    .me {
      align-self: flex-end;
      background: #e9e9e9;
    }
    .bot {
      align-self: flex-start;
      background: #ffffff;
      border: 1px solid #eee;
    }
    .row {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    input {
      flex: 1;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid #ddd;
      font-size: 15px;
    }
    button, select {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
    }
    small { opacity: .6; }
  </style>
</head>
<body>

<h1>MBTI Chatbot ğŸ§ </h1>

<div class="row">
  <select id="mbti"></select>
  <select id="verbosity">
    <option value="short">çŸ­ã‚</option>
    <option value="normal" selected>æ™®é€š</option>
    <option value="long">è©³ã—ã‚</option>
  </select>
</div>

<small>â€» ç„¡æ–™ / APIã‚­ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«å­˜åœ¨ã—ã¾ã›ã‚“</small>

<div id="chat"></div>

<div class="row">
  <input id="msg" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›â€¦" />
  <button id="send">é€ä¿¡</button>
</div>

<script type="module">
  import { MBTI_LIST, MBTI_POLICIES } from "./mbti_policies.js";

  const chat = document.getElementById("chat");
  const msg = document.getElementById("msg");
  const sendBtn = document.getElementById("send");
  const mbtiSel = document.getElementById("mbti");
  const verbSel = document.getElementById("verbosity");

  const saved = JSON.parse(localStorage.getItem("mbtiSettings") || "{}");

  const state = {
    mbti: saved.mbti || "INTJ",
    verbosity: saved.verbosity || "normal",
    history: []
  };

  MBTI_LIST.forEach(t => {
    const o = document.createElement("option");
    o.value = t;
    o.textContent = t;
    mbtiSel.appendChild(o);
  });

  mbtiSel.value = state.mbti;
  verbSel.value = state.verbosity;

  mbtiSel.onchange = () => {
    state.mbti = mbtiSel.value;
    save();
  };
  verbSel.onchange = () => {
    state.verbosity = verbSel.value;
    save();
  };

  function save() {
    localStorage.setItem("mbtiSettings", JSON.stringify({
      mbti: state.mbti,
      verbosity: state.verbosity
    }));
  }

  function add(text, cls) {
    const d = document.createElement("div");
    d.className = "msg " + cls;
    d.textContent = text;
    chat.appendChild(d);
    chat.scrollTop = chat.scrollHeight;
  }

  function systemPrompt() {
    const len =
      state.verbosity === "short" ? "çŸ­ãè¦ç‚¹ã®ã¿ã€‚" :
      state.verbosity === "long"  ? "è©³ã—ãã€æ ¹æ‹ ã¨æ‰‹é †ã‚‚å«ã‚ã‚‹ã€‚" :
      "èª­ã¿ã‚„ã™ã„æ¨™æº–çš„ãªé•·ã•ã€‚";

    return `
ã‚ãªãŸã¯MBTIã®è¿”ç­”ã‚¹ã‚¿ã‚¤ãƒ«ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã€‚
äººã‚’è¨ºæ–­ãƒ»æ–­å®šã—ãªã„ã€‚ã‚ãã¾ã§æ–‡ç« ã‚¹ã‚¿ã‚¤ãƒ«ã¨ã—ã¦é©ç”¨ã™ã‚‹ã€‚
è¿”ç­”ãƒ«ãƒ¼ãƒ«ï¼š${len}

ã€MBTIãƒãƒªã‚·ãƒ¼ã€‘
${MBTI_POLICIES[state.mbti]}
`.trim();
  }

  async function send() {
    const text = msg.value.trim();
    if (!text) return;
    msg.value = "";

    add(text, "me");
    state.history.push({ role: "user", content: text });

    add("â€¦è€ƒãˆä¸­", "bot");
    const loading = chat.lastChild;

    try {
      const res = await fetch("https://ai.taisei-study928.workers.dev/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
